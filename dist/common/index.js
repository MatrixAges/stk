import{flatten as e,initial as t,last as i,omit as n}from"es-toolkit";import{debounce as s,find as r,flatMap as h,get as l,reduceRight as d}from"es-toolkit/compat";import{makeAutoObservable as o,observe as c,reaction as u,toJS as p}from"mobx";import{deepEqual as a}from"fast-equals";class f{constructor(){this.tree=[],o(this,null,{autoBind:!0})}init(e){let t=this.getRawTreeMap(e),{tree:i,tree_map:n,lost_tree:s}=this.getTree(e,t),{tree:r,lost_tree:h}=this.sortTree(i,n,s);return this.tree=r,h}find(e,t){let i=t||this.tree;for(let t=0;t<i.length;t++){let n=i[t];if(n.id===e)return n;if(n.children)return this.find(e,n.children)}}insert(e,t){let{target_level:i,cloned_item:n}=this.getDroppableItem(t),{active_item:s,effect_items:r}=this.place({type:"push",active_item:e,over_item:n,target_level:i});return{item:s,effect_items:r}}remove(e){let{cloned_item:t,effect_items:i}=this.take(e),n=[];return t?.children?.length&&(n=this.getherItems(t.children)),{id:t.id,remove_items:n,effect_items:i}}update(e,t){if(!e.length){let e=this.find(t.id);if(!e)return;Object.keys(n(t,["id"])).forEach(i=>{e[i]=t[i]});return}let{item:i,target_level:s,target_index:r}=this.getItem(e),h={...i,...t};return s[r]=h,h}move(t){let{active_parent_index:n,over_parent_index:s,droppable:r}=t,{cloned_item:h}=this.getItem(n),{cloned_item:l,target_level:d}=r?this.getDroppableItem(s):this.getItem(s);if(l.next_id===h.id&&!r)return{effect_items:[]};let o=h.next_id===l.id&&!r,c=()=>{let{effect_items:e}=this.place({type:r?"push":"insert",active_item:h,over_item:l,target_level:d,over_index:i(s)});return e},u=()=>{let{effect_items:e}=this.take(n,o);return e},p=e((h.pid===l.pid?i(n)<i(s)?[c,u]:[u,c]:n.length>s.length?[u,c]:[c,u]).map(e=>e()));return{effect_items:this.getUniqEffectItems(p)}}getItem(e){let n=[],s=0,r=null,h=this.getIndexes(e),d=t(h);return s=i(e),r=l(this.tree,h),n=d.length?l(this.tree,d):this.tree,{item:r,cloned_item:p(r),target_level:n,target_index:s}}getDroppableItem(e){if(!e.length)return{target_level:this.tree,cloned_item:null};let t=null,i=[];return i=1===e.length?e:this.getIndexes(e),(t=l(this.tree,i)).children||(t.children=[]),{target_level:t.children,cloned_item:p(t)}}getRawTreeMap(e){let t={};return e.map(e=>{t[e.id]=e}),t}getTree(e,t){let i=[],n=[];return e.forEach(e=>{let s=t[e.prev_id],r=t[e.next_id];e.prev_id===e.next_id||!t[e.id]||s&&s.prev_id===s.next_id||r&&r.prev_id===r.next_id?(e.prev_id=void 0,e.next_id=void 0,e.pid=void 0,t[e.id]=e,n.push(e)):e.pid?(t[e.pid].children||(t[e.pid].children=[]),t[e.pid]?.children?.length?t[e.pid].children.push(e):t[e.pid].children=[e]):i.push(e)}),{tree:i,tree_map:t,lost_tree:n}}sortTree(e,t,i){let n=[],s=r(e,e=>!e.prev_id);if(!s){if(i&&i.length){let e=this.sortLostTree(i,t);return{tree:e,lost_tree:e}}return{tree:[],lost_tree:[]}}let h=s.id;for(;h;){let e=t[h];e?.children?.length&&(e.children=this.sortTree(e.children,t).tree),n.push(e),h=e.next_id}if(i&&i.length){let e=this.sortLostTree(i,t);e[0].prev_id=n.at(-1).id,n.push(...e)}return{tree:n,lost_tree:i}}sortLostTree(e,t){return e.map((i,n)=>{let s=e.at(n+1);return s&&(i.next_id=s.id,s.prev_id=i.id,t[i.id]=i,t[s.id]=s),i})}take(e,t){let{cloned_item:i,target_level:n,target_index:s}=this.getItem(e),r=[];if(i.prev_id){let e=n[s-1];e.next_id=i.next_id??"",r.push(p(e))}if(i.next_id){let e=n[s+1];e.prev_id=i.prev_id??"",t&&(e.next_id=i.id),r.push(p(e))}return n.splice(s,1),{cloned_item:i,effect_items:r}}place(e){let{type:t,active_item:n,over_item:s,target_level:r,over_index:h}=e,l=[];if("push"===t){if(n.pid=s?s.id:"",r.length){let e=i(r);e.next_id=n.id,n.prev_id=e.id,l.push(p(e))}else n.prev_id=void 0;n.next_id=void 0,l.push(p(n)),r.push(n)}else{if(n.pid=s.pid,n.prev_id=s.id,n.next_id=s.next_id,s.next_id){let e=r[h+1];e.prev_id=n.id,l.push(p(e))}else n.next_id=void 0;n.next_id===s.id?s.next_id=n.next_id:s.next_id=n.id,l.push(p(n)),l.push(p(s)),r.splice(h+1,0,n)}return{active_item:n,effect_items:l}}getUniqEffectItems(e){return d(e,(e,t)=>(e.some(e=>e.id===t.id)||e.unshift(t),e),[])}getIndexes(e){return h(e,(t,i)=>i<e.length-1?[t,"children"]:[t])}getherItems(e){return e.reduce((e,t)=>(e.push(t),t?.children?.length&&e.push(...this.getherItems(t.children)),e),[])}}let g=(e,t,i)=>{t.forEach(t=>{e.addEventListener(t,s(i,900,{leading:!0}))})},m=(e,t,i)=>{t.forEach(t=>{e.removeEventListener(t,s(i,900,{leading:!0}))})};class _{constructor(){this.config={context:null,events:["mousemove","scroll","keydown","mousedown","touchstart"],onIdle:null,onActive:null,onHide:null,onShow:null},this.time=6e4,this.idle=!1,this.visible=!0,this.timer=null,this.acts=[],this.watch={time:e=>{this.off(),e&&this.on()}},o(this,{config:!1,timer:!1,acts:!1},{autoBind:!0}),this.acts=[...(e=>{let t=e.watch,i={},n={},s=[];return Object.keys(t).map(e=>{if(-1!==e.indexOf("|")){let t=e.split("|");s.push(...t.map(t=>({key:t,raw:e})))}-1!==e.indexOf(".")?i[e]=t[e]:n[e]=t[e]}),[...Object.keys(i).map(t=>u(()=>l(e,t),(e,n)=>{let s=p(e),r=p(n);a(s,r)||i[t](s,r)})),c(e,i=>{let{name:n,newValue:r,oldValue:h}=i,d=s.find(e=>{if(e.key===n)return e});if(d){let i=d.raw.split("|");i.includes(n)&&t[d.raw](i.map(t=>l(e,t)))}if(t[n]){let e=p(r),i=p(h);a(e,i)||t[n](e,i)}})]})(this)]}init(e,t){e&&(this.time=e,this.config=Object.assign(this.config,t),this.on())}on(){this.start(),g(window,this.config.events,this.active.bind(this.config.context??this)),(this.config.onShow||this.config.onHide)&&g(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}off(){this.timer&&clearTimeout(this.timer),this.acts.map(e=>e()),m(window,this.config.events,this.active.bind(this.config.context??this)),(this.config.onShow||this.config.onHide)&&m(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}start(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.idle=!0,this.config.onIdle&&this.config.onIdle.call(this.config.context??this)},this.time)}active(){this.idle&&(this.idle=!1,this.config.onActive&&this.config.onActive.call(this.config.context??this)),this.start()}changeVisible(){document.hidden?this.visible&&(this.visible=!1,this.config.onHide&&this.config.onHide.call(this.config.context??this)):!this.visible&&(this.visible=!0,this.config.onShow&&this.config.onShow.call(this.config.context??this))}}let v=(e,t)=>{let i={};return e.forEach(e=>{i[e[t]]=e}),Object.values(i)},x=e=>{let{prefix:t,size:i=12}=e||{},n="userandom26T198340PX75pxJACKVERYMINDBUSHWOLFGQZbfghjklqvwyzrict",s=new Uint8Array(i);window.crypto.getRandomValues(s);let r="";for(let e=0;e<i;e++)r+=n[s[e]%n.length];return(t?`${t}_`:"")+r};export{f as DirTree,_ as Idle,x as id,v as uniqBy};