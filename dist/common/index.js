import*as e from"es-toolkit";import*as t from"es-toolkit/compat";import*as i from"mobx";import*as n from"fast-equals";class s{constructor(){this.tree=[],(0,i.makeAutoObservable)(this,null,{autoBind:!0})}init(e){let t=this.getRawTreeMap(e),{tree:i,tree_map:n,lost_tree:s}=this.getTree(e,t),{tree:r,lost_tree:h}=this.sortTree(i,n,s);return this.tree=r,h}find(e,t){let i=t||this.tree;for(let t=0;t<i.length;t++){let n=i[t];if(n.id===e)return n;if(n.children)return this.find(e,n.children)}}insert(e,t){let{target_level:i,cloned_item:n}=this.getDroppableItem(t),{active_item:s,effect_items:r}=this.place({type:"push",active_item:e,over_item:n,target_level:i});return{item:s,effect_items:r}}remove(e){let{cloned_item:t,effect_items:i}=this.take(e),n=[];return t?.children?.length&&(n=this.getherItems(t.children)),{id:t.id,remove_items:n,effect_items:i}}update(t,i){if(!t.length){let t=this.find(i.id);if(!t)return;Object.keys((0,e.omit)(i,["id"])).forEach(e=>{t[e]=i[e]});return}let{item:n,target_level:s,target_index:r}=this.getItem(t),h={...n,...i};return s[r]=h,h}move(t){let{active_parent_index:i,over_parent_index:n,droppable:s}=t,{cloned_item:r}=this.getItem(i),{cloned_item:h,target_level:l}=s?this.getDroppableItem(n):this.getItem(n);if(h.next_id===r.id&&!s)return{effect_items:[]};let d=r.next_id===h.id&&!s,o=[],c=()=>{let{effect_items:t}=this.place({type:s?"push":"insert",active_item:r,over_item:h,target_level:l,over_index:(0,e.last)(n)});return t},a=()=>{let{effect_items:e}=this.take(i,d);return e};o=r.pid===h.pid?(0,e.last)(i)<(0,e.last)(n)?[c,a]:[a,c]:i.length>n.length?[a,c]:[c,a];let u=(0,e.flatten)(o.map(e=>e()));return{effect_items:this.getUniqEffectItems(u)}}getItem(n){let s=[],r=0,h=null,l=this.getIndexes(n),d=(0,e.initial)(l);return r=(0,e.last)(n),h=(0,t.get)(this.tree,l),s=d.length?(0,t.get)(this.tree,d):this.tree,{item:h,cloned_item:(0,i.toJS)(h),target_level:s,target_index:r}}getDroppableItem(e){if(!e.length)return{target_level:this.tree,cloned_item:null};let n=null,s=[];return s=1===e.length?e:this.getIndexes(e),(n=(0,t.get)(this.tree,s)).children||(n.children=[]),{target_level:n.children,cloned_item:(0,i.toJS)(n)}}getRawTreeMap(e){let t={};return e.map(e=>{t[e.id]=e}),t}getTree(e,t){let i=[],n=[];return e.forEach(e=>{let s=t[e.prev_id],r=t[e.next_id];e.prev_id===e.next_id||!t[e.id]||s&&s.prev_id===s.next_id||r&&r.prev_id===r.next_id?(e.prev_id=void 0,e.next_id=void 0,e.pid=void 0,t[e.id]=e,n.push(e)):e.pid?(t[e.pid].children||(t[e.pid].children=[]),t[e.pid]?.children?.length?t[e.pid].children.push(e):t[e.pid].children=[e]):i.push(e)}),{tree:i,tree_map:t,lost_tree:n}}sortTree(e,i,n){let s=[],r=(0,t.find)(e,e=>!e.prev_id);if(!r){if(n&&n.length){let e=this.sortLostTree(n,i);return{tree:e,lost_tree:e}}return{tree:[],lost_tree:[]}}let h=r.id;for(;h;){let e=i[h];e?.children?.length&&(e.children=this.sortTree(e.children,i).tree),s.push(e),h=e.next_id}if(n&&n.length){let e=this.sortLostTree(n,i);e[0].prev_id=s.at(-1).id,s.push(...e)}return{tree:s,lost_tree:n}}sortLostTree(e,t){return e.map((i,n)=>{let s=e.at(n+1);return s&&(i.next_id=s.id,s.prev_id=i.id,t[i.id]=i,t[s.id]=s),i})}take(e,t){let{cloned_item:n,target_level:s,target_index:r}=this.getItem(e),h=[];if(n.prev_id){let e=s[r-1];e.next_id=n.next_id??"",h.push((0,i.toJS)(e))}if(n.next_id){let e=s[r+1];e.prev_id=n.prev_id??"",t&&(e.next_id=n.id),h.push((0,i.toJS)(e))}return s.splice(r,1),{cloned_item:n,effect_items:h}}place(t){let{type:n,active_item:s,over_item:r,target_level:h,over_index:l}=t,d=[];if("push"===n){if(s.pid=r?r.id:"",h.length){let t=(0,e.last)(h);t.next_id=s.id,s.prev_id=t.id,d.push((0,i.toJS)(t))}else s.prev_id=void 0;s.next_id=void 0,d.push((0,i.toJS)(s)),h.push(s)}else{if(s.pid=r.pid,s.prev_id=r.id,s.next_id=r.next_id,r.next_id){let e=h[l+1];e.prev_id=s.id,d.push((0,i.toJS)(e))}else s.next_id=void 0;s.next_id===r.id?r.next_id=s.next_id:r.next_id=s.id,d.push((0,i.toJS)(s)),d.push((0,i.toJS)(r)),h.splice(l+1,0,s)}return{active_item:s,effect_items:d}}getUniqEffectItems(e){return(0,t.reduceRight)(e,(e,t)=>(e.some(e=>e.id===t.id)||e.unshift(t),e),[])}getIndexes(e){return(0,t.flatMap)(e,(t,i)=>i<e.length-1?[t,"children"]:[t])}getherItems(e){return e.reduce((e,t)=>(e.push(t),t?.children?.length&&e.push(...this.getherItems(t.children)),e),[])}}let r=e=>{let s=e.watch,r={},h={},l=[];return Object.keys(s).map(e=>{if(-1!==e.indexOf("|")){let t=e.split("|");l.push(...t.map(t=>({key:t,raw:e})))}-1!==e.indexOf(".")?r[e]=s[e]:h[e]=s[e]}),[...Object.keys(r).map(s=>(0,i.reaction)(()=>(0,t.get)(e,s),(e,t)=>{let h=(0,i.toJS)(e),l=(0,i.toJS)(t);(0,n.deepEqual)(h,l)||r[s](h,l)})),(0,i.observe)(e,r=>{let{name:h,newValue:d,oldValue:o}=r,c=l.find(e=>{if(e.key===h)return e});if(c){let i=c.raw.split("|");i.includes(h)&&s[c.raw](i.map(i=>(0,t.get)(e,i)))}if(s[h]){let e=(0,i.toJS)(d),t=(0,i.toJS)(o);(0,n.deepEqual)(e,t)||s[h](e,t)}})]},h=(e,i,n)=>{i.forEach(i=>{e.addEventListener(i,(0,t.debounce)(n,900,{leading:!0}))})},l=(e,i,n)=>{i.forEach(i=>{e.removeEventListener(i,(0,t.debounce)(n,900,{leading:!0}))})};class d{constructor(){this.config={context:null,events:["mousemove","scroll","keydown","mousedown","touchstart"],onIdle:null,onActive:null,onHide:null,onShow:null},this.time=6e4,this.idle=!1,this.visible=!0,this.timer=null,this.acts=[],this.watch={time:e=>{this.off(),e&&this.on()}},(0,i.makeAutoObservable)(this,{config:!1,timer:!1,acts:!1},{autoBind:!0}),this.acts=[...r(this)]}init(e,t){e&&(this.time=e,this.config=Object.assign(this.config,t),this.on())}on(){this.start(),h(window,this.config.events,this.active.bind(this.config.context??this)),(this.config.onShow||this.config.onHide)&&h(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}off(){this.timer&&clearTimeout(this.timer),this.acts.map(e=>e()),l(window,this.config.events,this.active.bind(this.config.context??this)),(this.config.onShow||this.config.onHide)&&l(document,["visibilitychange"],this.changeVisible.bind(this.config.context??this))}start(){this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this.idle=!0,this.config.onIdle&&this.config.onIdle.call(this.config.context??this)},this.time)}active(){this.idle&&(this.idle=!1,this.config.onActive&&this.config.onActive.call(this.config.context??this)),this.start()}changeVisible(){document.hidden?this.visible&&(this.visible=!1,this.config.onHide&&this.config.onHide.call(this.config.context??this)):!this.visible&&(this.visible=!0,this.config.onShow&&this.config.onShow.call(this.config.context??this))}}let o=(e,t)=>{let i={};return e.forEach(e=>{i[e[t]]=e}),Object.values(i)},c=e=>{e||(e=30);let t="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",i=new Uint8Array(e);window.crypto.getRandomValues(i);let n="";for(let s=0;s<e;s++)n+=t[i[s]%t.length];return n};export{s as DirTree,d as Idle,c as id,o as uniqBy};