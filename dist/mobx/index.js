import{get as e,observe as t,reaction as r,set as o,toJS as n}from"mobx";import{get as l}from"es-toolkit/compat";import{deepEqual as i}from"fast-equals";import a from"rfdc";let f=new WeakMap;function y(e,t,r){let o={ctx:this,fn:r},n=f.get(e);n||f.set(e,n=new Map);let l=n.get(t);return l?l.push(o):n.set(t,[o]),()=>c(e,t,r)}function p(e,t,r){let o=this,n=(l,i)=>{c(e,t,n),r.call(o,l,i)};n.fn=r,y(e,t,n)}function c(e,t,r){if(void 0===t)return void f.set(e,new Map);let o=f.get(e);if(o){let e=o.get(t);if(e&&e.length>0){let n=[];r&&(n=e.filter(e=>e.fn!==r&&e.fn?.fn!==r)),o.set(t,n)}}}function s(e,t,...r){let o=f.get(e);if(o){let e=o.get(t);if(e){let[t,o]=r;e.forEach(e=>e.fn.call(e.ctx,t,o))}}}let g=Array.isArray,u=e=>null!==e&&"object"==typeof e,_=e=>"string"==typeof e&&"NaN"!==e&&"-"!==e[0]&&""+parseInt(e,10)===e,d=e=>Object.prototype.toString.call(e),k=(e,t)=>!Object.is(e,t);function w(e){try{return JSON.parse(e)}catch(t){return e}}let x=Object.prototype.hasOwnProperty,m=(e,t)=>x.call(e,t),h=new WeakMap,S={storage:{},key:"",proxy:{}},$=!0;function v(e,t){return function(){delete e[t]}}function b(e,t,...r){let o=`${S.key}.${t}`;g(e)&&_(t)&&(o=`${S.key}[${t}]`),s(S.storage,o,...r)}let O=!1,j=function(){let e={};return["push","pop","shift","unshift","splice"].forEach(t=>{e[t]=function(...e){O=!0;let r=this.length,o=h.get(this)[t].apply(this,e);return this.length>r&&b(this,"length",this.length,r),O=!1,o}}),e}();function E(e,t,r){return g(e)&&m(j,t)?Reflect.get(j,t,r):Reflect.get(e,t,r)}function I(e){$=!1;let t=S.proxy.getExpires(S.key);S.proxy[S.key]=e,t&&S.proxy.setExpires(S.key,t),$=!0}function D(e,t,r,o){let n;g(e)&&!O&&(n=e.length);let l=e[t],i=g(e)&&_(t)?Number(t)<e.length:m(e,t),a=Reflect.set(e,t,r,o);return a&&k(r,l)&&(i?b(e,t,r,l):b(e,t,r,void 0),g(e)&&void 0!==n&&Number(t)>=n&&b(e,"length",e.length,n),I(e)),a}function N(e,t){let r=m(e,t),o=e[t],n=Reflect.deleteProperty(e,t);return n&&r&&(b(e,t,void 0,o),I(e)),n}function P(e){let t=new Proxy(e,{get:E,set:D,deleteProperty:N});return h.set(t,e),t}let R={String:{read:e=>e,write:e=>e},Number:{read:e=>Number.parseFloat(e),write:e=>String(e)},BigInt:{read:e=>BigInt(e),write:e=>String(e)},Boolean:{read:e=>"true"===e,write:e=>String(e)},Null:{read:()=>null,write:e=>String(e)},Undefined:{read:()=>void 0,write:e=>String(e)},Object:{read:e=>P(e),write:e=>e},Array:{read:e=>P(e),write:e=>e},Set:{read:e=>new Set(e),write:e=>Array.from(e)},Map:{read:e=>new Map(e),write:e=>Array.from(e)},Date:{read:e=>new Date(e),write:e=>String(e)},RegExp:{read:e=>(0,eval)(e),write:e=>String(e)},Function:{read:e=>(0,eval)(`(function() { return ${e} })()`),write:e=>String(e)}};function M(e,t){if(!e)return;let r=e;try{r=w(e)}catch(e){}if(!u(r))return r;if(r.expires&&new Date(+r.expires).getTime()<=Date.now())return void t?.();let o=R[r.type];return o?o.read(r.value):r.value}function H(e,t){let r=d(e).slice(8,-1),o=R[r];if(!o)throw Error(`can't set "${r}" property.`);let n={type:r,value:o.write(e)};return t&&(n.expires=t),JSON.stringify(n)}function V(e,t,r,o){let n;if((n="[object Date]"===d(r)?r.getTime():"string"==typeof r?+r.padEnd(13,"0"):r)<=Date.now())return void delete o[t];let l=o[t];if(l)return l=h.get(l)||l,e[`${window.__storage_prefix__||""}${t}`]=H(l,""+n),new Date(n)}function W(e,t){let r=`${window.__storage_prefix__||""}${t}`;if(!e[r])return;let o=w(e[r]);if(!(!u(o)||!o.expires||+o.expires<=Date.now()))return new Date(+o.expires)}function A(e,t,r){let o=r[t];o&&(o=h.get(o)||o,e[`${window.__storage_prefix__||""}${t}`]=H(o))}let B=new Map;function C(e,t,r){$&&(S.storage=e,S.key=t,S.proxy=r);let o=B.get(e);if(o||(o=function(e,t){let r={};["clear","key"].forEach(t=>{r[t]=e[t].bind(e)});let o={getItem:C,setItem:F,setExpires:V,removeExpires:A};Object.keys(o).forEach(n=>{r[n]=function(...r){return o[n](e,...r,t)}});let n={removeItem:T,getExpires:W,off:c,on:y,once:p};return Object.keys(n).forEach(t=>{r[t]=function(...r){return n[t](e,...r)}}),r}(e,r),B.set(e,o)),m(o,t))return Reflect.get(o,t,r);if(!J(e,t))return;let n=`${window.__storage_prefix__||""}${t}`,l=e[n]||e[t];return l?M(l,v(e,n)):l}function F(e,t,r,o){let n=`${window.__storage_prefix__||""}${t}`,l=M(e[n],v(e,n));l=h.get(l)||l;let i=Reflect.set(e,n,H(r),o);return i&&k(r,l)&&$&&s(e,t,r,l),i}function J(e,t){return e.hasOwnProperty(`${window.__storage_prefix__||""}${t}`)||!e.hasOwnProperty(t)&&t in e}function T(e,t){let r=`${window.__storage_prefix__||""}${t}`,o=m(e,r),n=M(e[r],v(e,r));n=h.get(n)||n;let l=Reflect.deleteProperty(e,r);return l&&o&&s(e,t,void 0,n),l}function q(e){return e?new Proxy(e,{get:C,set:F,has:J,deleteProperty:T}):null}let L="undefined"!=typeof localStorage?localStorage:void 0,U="undefined"!=typeof sessionStorage?sessionStorage:void 0;"undefined"!=typeof window&&window.addEventListener("storage",e=>{if(e.key&&e.key.startsWith(window.__storage_prefix__||"")){let t=e.newValue,r=e.oldValue;e.newValue&&u(t=M(e.newValue,v(L,e.key)))&&(t=h.get(t)||t),e.oldValue&&u(r=M(e.oldValue,v(L,e.key)))&&(r=h.get(r)||r),s(L,e.key.slice((window.__storage_prefix__||"").length),t,r)}});let z=q(L),G=q(U),K=e=>{if("string"==typeof e)return{local_key:e,proxy_key:e};{let t=Object.keys(e)[0],r=e[t];return"function"==typeof r?{local_key:t,proxy_key:t,getHandler:r}:r&&"object"==typeof r?{local_key:r.local_key||t,proxy_key:t,fromStorage:r.fromStorage,toStorage:r.toStorage}:{local_key:t,proxy_key:r}}},Q=(r,n,l)=>{let i=l?.useSession?G:z;return r.map(t=>{let r=K(t),l=i.getItem(r.local_key);void 0!==l?r.fromStorage?o(n,r.proxy_key,r.fromStorage(l)):r.getHandler?o(n,r.proxy_key,r.getHandler(l)):o(n,r.proxy_key,l):r.toStorage?i.setItem(r.local_key,r.toStorage(e(n,r.proxy_key))):i.setItem(r.local_key,e(n,r.proxy_key))}),t(n,({name:e,newValue:t})=>{r.map(r=>{let o=K(r);e===o.proxy_key&&(o.toStorage?i.setItem(o.local_key,o.toStorage(t)):i.setItem(o.local_key,t))})})},X=(e,t)=>{if("string"==typeof e)return{local_key:e,proxy_key:e};{let r=Object.keys(e),o=t?`${t}:${r[0]}`:r[0],n=e[o];return"function"==typeof n?{local_key:o,proxy_key:o,getHandler:n}:n&&"object"==typeof n?{local_key:n.local_key||o,proxy_key:o,fromStorage:n.fromStorage,toStorage:n.toStorage}:{local_key:o,proxy_key:n}}},Y=async(r,n,l)=>{let{namespace:i,useSession:a,get:f,set:y}=l||{},p=a?G:z,c=f||p.getItem,s=y||p.setItem;for(let t of r){let r=X(t,i),l=await c(r.local_key);void 0!==l?r.fromStorage?o(n,r.proxy_key,r.fromStorage(l)):r.getHandler?o(n,r.proxy_key,r.getHandler(l)):o(n,r.proxy_key,l):r.toStorage?s(r.local_key,r.toStorage(e(n,r.proxy_key))):s(r.local_key,e(n,r.proxy_key))}return t(n,({name:e,newValue:t})=>{r.map(r=>{let o=X(r,i);e===o.proxy_key&&(o.toStorage?s(o.local_key,o.toStorage(t)):s(o.local_key,t))})})},Z=e=>{let o=e.watch,a={},f={},y=[];return Object.keys(o).map(e=>{if(-1!==e.indexOf("|")){let t=e.split("|");y.push(...t.map(t=>({key:t,raw:e})))}-1!==e.indexOf(".")?a[e]=o[e]:f[e]=o[e]}),[...Object.keys(a).map(t=>r(()=>l(e,t),(e,r)=>{let o=n(e),l=n(r);i(o,l)||a[t](o,l)})),t(e,t=>{let{name:r,newValue:a,oldValue:f}=t,p=y.find(e=>{if(e.key===r)return e});if(p){let t=p.raw.split("|");t.includes(r)&&o[p.raw](t.map(t=>l(e,t)))}if(o[r]){let e=n(a),t=n(f);i(e,t)||o[r](e,t)}})]},ee=a({proto:!0});export{ee as copy,Q as setStorageWhenChange,Y as setStoreWhenChange,Z as useInstanceWatch};