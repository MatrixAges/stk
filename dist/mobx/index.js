import{get as e,observe as t,reaction as r,set as n,toJS as o}from"mobx";import{get as i}from"es-toolkit/compat";import{deepEqual as l}from"fast-equals";let a=new WeakMap;function f(e,t,r){let n={ctx:this,fn:r},o=a.get(e);o||a.set(e,o=new Map);let i=o.get(t);return i?i.push(n):o.set(t,[n]),()=>s(e,t,r)}function u(e,t,r){let n=this,o=(i,l)=>{s(e,t,o),r.call(n,i,l)};o.fn=r,f(e,t,o)}function s(e,t,r){if(void 0===t)return void a.set(e,new Map);let n=a.get(e);if(n){let e=n.get(t);if(e&&e.length>0){let o=[];r&&(o=e.filter(e=>e.fn!==r&&e.fn?.fn!==r)),n.set(t,o)}}}function p(e,t,...r){let n=a.get(e);if(n){let e=n.get(t);if(e){let[t,n]=r;e.forEach(e=>e.fn.call(e.ctx,t,n))}}}let c=Array.isArray,g=e=>"[object Date]"===w(e),y=e=>"string"==typeof e,d=e=>null!==e&&"object"==typeof e,_=e=>"string"==typeof e&&"NaN"!==e&&"-"!==e[0]&&""+parseInt(e,10)===e,w=e=>Object.prototype.toString.call(e),x=e=>w(e).slice(8,-1),k=(e,t)=>!Object.is(e,t);function h(e){try{return JSON.parse(e)}catch(t){return e}}let m=Object.prototype.hasOwnProperty,S=(e,t)=>m.call(e,t);function v(e){return(0,eval)(e)}let $=new WeakMap,b={storage:{},key:"",proxy:{}},O=!0;function E(e,t){return function(){delete e[t]}}function j(e,t,...r){let n=`${b.key}.${t}`;c(e)&&_(t)&&(n=`${b.key}[${t}]`),p(b.storage,n,...r)}let I=!1,D=function(){let e={};return["push","pop","shift","unshift","splice"].forEach(t=>{e[t]=function(...e){I=!0;let r=this.length,n=$.get(this)[t].apply(this,e);return this.length>r&&j(this,"length",this.length,r),I=!1,n}}),e}();function N(e,t,r){return c(e)&&S(D,t)?Reflect.get(D,t,r):Reflect.get(e,t,r)}function P(e){O=!1;let t=b.proxy.getExpires(b.key);b.proxy[b.key]=e,t&&b.proxy.setExpires(b.key,t),O=!0}function R(e,t,r,n){let o;c(e)&&!I&&(o=e.length);let i=e[t],l=c(e)&&_(t)?Number(t)<e.length:S(e,t),a=Reflect.set(e,t,r,n);return a&&k(r,i)&&(l?j(e,t,r,i):j(e,t,r,void 0),c(e)&&void 0!==o&&Number(t)>=o&&j(e,"length",e.length,o),P(e)),a}function M(e,t){let r=S(e,t),n=e[t],o=Reflect.deleteProperty(e,t);return o&&r&&(j(e,t,void 0,n),P(e)),o}function V(e){let t=new Proxy(e,{get:N,set:R,deleteProperty:M});return $.set(t,e),t}let A={String:{read:e=>e,write:e=>e},Number:{read:e=>Number.parseFloat(e),write:e=>String(e)},BigInt:{read:e=>BigInt(e),write:e=>String(e)},Boolean:{read:e=>"true"===e,write:e=>String(e)},Null:{read:()=>null,write:e=>String(e)},Undefined:{read:()=>void 0,write:e=>String(e)},Object:{read:e=>V(e),write:e=>e},Array:{read:e=>V(e),write:e=>e},Set:{read:e=>new Set(e),write:e=>Array.from(e)},Map:{read:e=>new Map(e),write:e=>Array.from(e)},Date:{read:e=>new Date(e),write:e=>String(e)},RegExp:{read:e=>(0,eval)(e),write:e=>String(e)},Function:{read:e=>(0,eval)(`(function() { return ${e} })()`),write:e=>String(e)}};function W(e,t){if(!e)return;let r=e;try{r=h(e)}catch(e){}if(!d(r))return r;if(r.expires&&new Date(+r.expires).getTime()<=Date.now())return void t?.();let n=A[r.type];return n?n.read(r.value):r.value}function B(e,t){let r=x(e),n=A[r];if(!n)throw Error(`can't set "${r}" property.`);let o={type:r,value:n.write(e)};return t&&(o.expires=t),JSON.stringify(o)}function H(e,t,r,n){let o;if((o=g(r)?r.getTime():y(r)?+r.padEnd(13,"0"):r)<=Date.now())return void delete n[t];let i=n[t];if(i)return i=$.get(i)||i,e[`${window.__storage_prefix__||""}${t}`]=B(i,""+o),new Date(o)}function F(e,t){let r=`${window.__storage_prefix__||""}${t}`;if(!e[r])return;let n=h(e[r]);if(!(!d(n)||!n.expires||+n.expires<=Date.now()))return new Date(+n.expires)}function J(e,t,r){let n=r[t];n&&(n=$.get(n)||n,e[`${window.__storage_prefix__||""}${t}`]=B(n))}let T=new Map;function q(e,t,r){O&&(b.storage=e,b.key=t,b.proxy=r);let n=T.get(e);if(n||(n=function(e,t){let r={};["clear","key"].forEach(t=>{r[t]=e[t].bind(e)});let n={getItem:q,setItem:C,setExpires:H,removeExpires:J};Object.keys(n).forEach(o=>{r[o]=function(...r){return n[o](e,...r,t)}});let o={removeItem:U,getExpires:F,off:s,on:f,once:u};return Object.keys(o).forEach(t=>{r[t]=function(...r){return o[t](e,...r)}}),r}(e,r),T.set(e,n)),S(n,t))return Reflect.get(n,t,r);if(!L(e,t))return;let o=`${window.__storage_prefix__||""}${t}`,i=e[o]||e[t];return i?W(i,E(e,o)):i}function C(e,t,r,n){let o=`${window.__storage_prefix__||""}${t}`,i=W(e[o],E(e,o));i=$.get(i)||i;let l=Reflect.set(e,o,B(r),n);return l&&k(r,i)&&O&&p(e,t,r,i),l}function L(e,t){return e.hasOwnProperty(`${window.__storage_prefix__||""}${t}`)||!e.hasOwnProperty(t)&&t in e}function U(e,t){let r=`${window.__storage_prefix__||""}${t}`,n=S(e,r),o=W(e[r],E(e,r));o=$.get(o)||o;let i=Reflect.deleteProperty(e,r);return i&&n&&p(e,t,void 0,o),i}function z(e){return e?new Proxy(e,{get:q,set:C,has:L,deleteProperty:U}):null}let G="undefined"!=typeof localStorage?localStorage:void 0,K="undefined"!=typeof sessionStorage?sessionStorage:void 0;"undefined"!=typeof window&&window.addEventListener("storage",e=>{if(e.key&&e.key.startsWith(window.__storage_prefix__||"")){let t=e.newValue,r=e.oldValue;e.newValue&&d(t=W(e.newValue,E(G,e.key)))&&(t=$.get(t)||t),e.oldValue&&d(r=W(e.oldValue,E(G,e.key)))&&(r=$.get(r)||r),p(G,e.key.slice((window.__storage_prefix__||"").length),t,r)}});let Q=z(G),X=z(K),Y=e=>{if("string"==typeof e)return{local_key:e,proxy_key:e};{let t=Object.keys(e)[0],r=e[t];return"function"==typeof r?{local_key:t,proxy_key:t,getHandler:r}:"object"==typeof r&&r?{local_key:t,proxy_key:t,fromStorage:r.fromStorage,toStorage:r.toStorage}:{local_key:t,proxy_key:r}}},Z=(r,o,i)=>{let l=i?.useSession?X:Q;return r.map(t=>{let r=Y(t),i=l.getItem(r.local_key);void 0!==i?r.fromStorage?n(o,r.proxy_key,r.fromStorage(i)):r.getHandler?n(o,r.proxy_key,r.getHandler(i)):n(o,r.proxy_key,i):r.toStorage?l.setItem(r.local_key,r.toStorage(e(o,r.proxy_key))):l.setItem(r.local_key,e(o,r.proxy_key))}),t(o,({name:e,newValue:t})=>{r.map(r=>{let n=Y(r);e===n.proxy_key&&(n.toStorage?l.setItem(n.local_key,n.toStorage(t)):l.setItem(n.local_key,t))})})},ee=e=>{let n=e.watch,a={},f={},u=[];return Object.keys(n).map(e=>{if(-1!==e.indexOf("|")){let t=e.split("|");u.push(...t.map(t=>({key:t,raw:e})))}-1!==e.indexOf(".")?a[e]=n[e]:f[e]=n[e]}),[...Object.keys(a).map(t=>r(()=>i(e,t),(e,r)=>{let n=o(e),i=o(r);l(n,i)||a[t](n,i)})),t(e,t=>{let{name:r,newValue:a,oldValue:f}=t,s=u.find(e=>{if(e.key===r)return e});if(s){let t=s.raw.split("|");t.includes(r)&&n[s.raw](t.map(t=>i(e,t)))}if(n[r]){let e=o(a),t=o(f);l(e,t)||n[r](e,t)}})]};export{Z as setStorageWhenChange,ee as useInstanceWatch};