import{deepEqual as e}from"fast-equals";import{createContext as r,createElement as t,memo as n,useContext as o,useReducer as u,useRef as c,useState as l}from"react";import{useEventListener as i,useIsomorphicLayoutEffect as s,useMemoizedFn as a,useUpdateEffect as p}from"ahooks";import{unstable_batchedUpdates as f}from"react-dom";import{unstable_NormalPriority as d,unstable_runWithPriority as m}from"scheduler";let v=r=>n(r,(r,t)=>e(r,t));class h{constructor(e){this.el=e}by(e){return this.el=e.call(this,this.el),this}get(){return this.el}}let E=r=>(t,n)=>{let o=c(null),u=c(0);void 0!==n&&e(n,o.current)||(o.current=n,u.current+=1),r(t,[u.current])},x=Symbol(),C=Symbol(),b=m?e=>m(d,e):e=>e();function g(e){var n;let o=r({[x]:{v:{current:e},n:{current:-1},l:new Set,u:e=>e()}});return o[C]=o.Provider,n=o.Provider,o.Provider=v(({value:e,children:r})=>{let o=c(e),u=c(0),[i,a]=l(null);i&&(i(e),a(null));let p=c(null);if(!p.current){let e=new Set;p.current={[x]:{v:o,n:u,l:e,u:(r,t)=>{f(()=>{u.current+=1;let n={n:u.current};t?.suspense&&(n.n*=-1,n.p=new Promise(e=>{a(()=>r=>{n.v=r,delete n.p,e(r)})})),e.forEach(e=>e(n)),r()})}}}}return s(()=>{o.current=e,u.current+=1,b(()=>{p.current[x].l.forEach(r=>{r({n:u.current,v:e})})})},[e]),t(n,{value:p.current},r)}),delete o.Consumer,o}function S(r,t){let n=o(r)[x];if("object"==typeof process&&"production"!==process.env.NODE_ENV&&!n)throw Error("useContextSelector requires special context");let{v:{current:c},n:{current:l},l:i}=n,a=t(c),[p,f]=u((r,n)=>{if(!n)return[c,a];if("p"in n)throw n.p;if(n.n===l)return e(r[1],a)?r:[c,a];try{if("v"in n){if(e(r[0],n.v))return r;let o=t(n.v);if(e(r[1],o))return r;return[n.v,o]}}catch(e){}return[...r]},[c,a]);return e(p[1],a)||f(),s(()=>(i.add(f),()=>{i.delete(f)}),[i]),p[1]}function w(e){return S(e,e=>e)}function N(e){let r=o(e)[x];if("object"==typeof process&&"production"!==process.env.NODE_ENV&&!r)throw Error("useContextUpdate requires special context");let{u:t}=r;return t}let y=({context:e,value:r,children:n})=>{let{[C]:o}=e;if("object"==typeof process&&"production"!==process.env.NODE_ENV&&!o)throw Error("BridgeProvider requires special context");return t(o,{value:r},n)},D=e=>{let r=o(e);if("object"==typeof process&&"production"!==process.env.NODE_ENV&&!r[x])throw Error("useBridgeValue requires special context");return r},_=(r,t)=>{let n=c(null);return n.current&&e(t,n.current.key)||(n.current={key:t,value:r()}),n.current.value},k=(e,r=300)=>{let t=c(0),n=c(null);return a((...o)=>{t.current+=1,clearTimeout(n.current),n.current=setTimeout(()=>{t.current=0},r),2===t.current&&(e(...o),t.current=0)})},q=()=>{let[e,r]=l(!1),[t,n]=l(),o=c(null);return i("mouseup",()=>{let e=window.getSelection();if(!e||!e.toString().length)return;let t=e.getRangeAt(0),o=t.commonAncestorContainer,u=!1,c=o;for(;c;){if(c.hasAttribute("contenteditable")&&c.getAttribute("contenteditable")){u=!0;break}if(c.parentNode)c=c.parentNode;else break}u&&(r(!0),n(t.getBoundingClientRect()))},{target:o}),{selection_container:o,markup_visible:e,markup_rect:t,closeMarkup:a(()=>r(!1))}},P=E(p);export{y as BridgeProvider,g as createContext,E as createDeepCompareEffect,e as deepEqual,h as handle,v as memo,D as useBridgeValue,w as useContext,S as useContextSelector,N as useContextUpdate,_ as useDeepMemo,P as useDeepUpdateEffect,k as useDoubleClick,q as useSelection};