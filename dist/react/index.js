import{deepEqual as e}from"fast-equals";import{createContext as t,createElement as r,memo as n,useContext as o,useReducer as u,useRef as c,useState as l}from"react";import{useEventListener as i,useIsomorphicLayoutEffect as s,useMemoizedFn as a,useUpdateEffect as p}from"ahooks";import{unstable_batchedUpdates as f}from"react-dom";import{unstable_NormalPriority as d,unstable_runWithPriority as m}from"scheduler";let v=t=>n(t,(t,r)=>e(t,r));class h{constructor(e){this.el=e}by(e){return this.el=e.call(this,this.el),this}get(){return this.el}}let E=t=>(r,n)=>{let o=c(null),u=c(0);void 0!==n&&e(n,o.current)||(o.current=n,u.current+=1),t(r,[u.current])},x=Symbol(),C=Symbol(),b=m?e=>m(d,e):e=>e();function g(e){var n;let o=t({[x]:{v:{current:e},n:{current:-1},l:new Set,u:e=>e()}});return o[C]=o.Provider,n=o.Provider,o.Provider=v(({value:e,children:t})=>{let o=c(e),u=c(0),[i,a]=l(null);i&&(i(e),a(null));let p=c(null);if(!p.current){let e=new Set;p.current={[x]:{v:o,n:u,l:e,u:(t,r)=>{f(()=>{u.current+=1;let n={n:u.current};r?.suspense&&(n.n*=-1,n.p=new Promise(e=>{a(()=>t=>{n.v=t,delete n.p,e(t)})})),e.forEach(e=>e(n)),t()})}}}}return s(()=>{o.current=e,u.current+=1,b(()=>{p.current[x].l.forEach(t=>{t({n:u.current,v:e})})})},[e]),r(n,{value:p.current},t)}),delete o.Consumer,o}function S(t,r){let n=o(t)[x];if("object"==typeof process&&"production"!==process.env.NODE_ENV&&!n)throw Error("useContextSelector requires special context");let{v:{current:c},n:{current:l},l:i}=n,a=r(c),[p,f]=u((t,n)=>{if(!n)return[c,a];if("p"in n)throw n.p;if(n.n===l)return e(t[1],a)?t:[c,a];try{if("v"in n){if(e(t[0],n.v))return t;let o=r(n.v);if(e(t[1],o))return t;return[n.v,o]}}catch(e){}return[...t]},[c,a]);return e(p[1],a)||f(),s(()=>(i.add(f),()=>{i.delete(f)}),[i]),p[1]}function w(e){return S(e,e=>e)}function N(e){let t=o(e)[x];if("object"==typeof process&&"production"!==process.env.NODE_ENV&&!t)throw Error("useContextUpdate requires special context");let{u:r}=t;return r}let y=({context:e,value:t,children:n})=>{let{[C]:o}=e;if("object"==typeof process&&"production"!==process.env.NODE_ENV&&!o)throw Error("BridgeProvider requires special context");return r(o,{value:t},n)},D=e=>{let t=o(e);if("object"==typeof process&&"production"!==process.env.NODE_ENV&&!t[x])throw Error("useBridgeValue requires special context");return t},_=(t,r)=>{let n=c(null);return e(r,n.current?.key)||(n.current={key:r,value:t()}),n.current.value},k=(e,t=300)=>{let r=c(0),n=c(null);return a((...o)=>{r.current+=1,clearTimeout(n.current),n.current=setTimeout(()=>{r.current=0},t),2===r.current&&(e(...o),r.current=0)})},q=()=>{let[e,t]=l(!1),[r,n]=l(),o=c(null);return i("mouseup",()=>{let e=window.getSelection();if(!e||!e.toString().length)return;let r=e.getRangeAt(0),o=r.commonAncestorContainer,u=!1,c=o;for(;c;){if(c.hasAttribute("contenteditable")&&c.getAttribute("contenteditable")){u=!0;break}if(c.parentNode)c=c.parentNode;else break}u&&(t(!0),n(r.getBoundingClientRect()))},{target:o}),{selection_container:o,markup_visible:e,markup_rect:r,closeMarkup:a(()=>t(!1))}},P=E(p);export{y as BridgeProvider,g as createContext,E as createDeepCompareEffect,e as deepEqual,h as handle,v as memo,D as useBridgeValue,w as useContext,S as useContextSelector,N as useContextUpdate,_ as useDeepMemo,P as useDeepUpdateEffect,k as useDoubleClick,q as useSelection};